<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4 The Lottery Data | Tutorial and Code for ‘LaLonde (1986) after Nearly Four Decades: Lessons Learned’</title>
<meta name="author" content="Guido Imbens, Yiqing Xu">
<meta name="description" content="4.1 The Imbens, Rubin, and Sacerdote (IRS) Lottery Data We now reanalyze the lottery data from Imbens, Rubin, and Sacerdote (2001), who carried out an original survey to investigate the impact of...">
<meta name="generator" content="bookdown 0.39 with bs4_book()">
<meta property="og:title" content="4 The Lottery Data | Tutorial and Code for ‘LaLonde (1986) after Nearly Four Decades: Lessons Learned’">
<meta property="og:type" content="book">
<meta property="og:description" content="4.1 The Imbens, Rubin, and Sacerdote (IRS) Lottery Data We now reanalyze the lottery data from Imbens, Rubin, and Sacerdote (2001), who carried out an original survey to investigate the impact of...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4 The Lottery Data | Tutorial and Code for ‘LaLonde (1986) after Nearly Four Decades: Lessons Learned’">
<meta name="twitter:description" content="4.1 The Imbens, Rubin, and Sacerdote (IRS) Lottery Data We now reanalyze the lottery data from Imbens, Rubin, and Sacerdote (2001), who carried out an original survey to investigate the impact of...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.7.0/transition.js"></script><script src="libs/bs3compat-0.7.0/tabs.js"></script><script src="libs/bs3compat-0.7.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tutorial and Code for ‘LaLonde (1986) after Nearly Four Decades: Lessons Learned’</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="getting-started.html"><span class="header-section-number">1</span> Getting Started</a></li>
<li><a class="" href="lalonde-dehejia-wahba-ldw-data.html"><span class="header-section-number">2</span> LaLonde-Dehejia-Wahba (LDW) Data</a></li>
<li><a class="" href="original-lalonde-data-male-sample.html"><span class="header-section-number">3</span> Original LaLonde Data (Male Sample)</a></li>
<li><a class="active" href="the-lottery-data.html"><span class="header-section-number">4</span> The Lottery Data</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/xuyiqing/lalonde">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="the-lottery-data" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> The Lottery Data<a class="anchor" aria-label="anchor" href="#the-lottery-data"><i class="fas fa-link"></i></a>
</h1>
<div id="the-imbens-rubin-and-sacerdote-irs-lottery-data" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> The Imbens, Rubin, and Sacerdote (IRS) Lottery Data<a class="anchor" aria-label="anchor" href="#the-imbens-rubin-and-sacerdote-irs-lottery-data"><i class="fas fa-link"></i></a>
</h2>
<p>We now reanalyze the lottery data from Imbens, Rubin, and Sacerdote (2001), who carried out an original survey to investigate the impact of the size of lottery prizes in Massachusetts during the mid-1980s on the economic behavior of lottery players. The primary outcome is post-winning labor earnings.</p>
<p>There are three treatment and control groups. The control group, termed “non-winners,” consists of 259 season ticket holders who have won a small, one-time prize, ranging from $100 to $5,000 (in essence, they are one-time, minor winners). The treatment groups, labeled “big winners” (43 individuals) and “small winners” (194 individuals), are those who clinched a major prize.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/lottery.RData"</span><span class="op">)</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">tr</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">winner</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">tr1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">bigwinner</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># big winner</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">tr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">bigwinner</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">d</span><span class="op">$</span><span class="va">winner</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># small winner</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">co</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">winner</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># control</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">college</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">educ</span> <span class="op">&gt;=</span> <span class="fl">16</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="assessing-overlap-2" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Assessing Overlap<a class="anchor" aria-label="anchor" href="#assessing-overlap-2"><i class="fas fa-link"></i></a>
</h2>
<p>In the subsequent analysis, we will consider labor earnings from seven post-lottery winning periods as the outcomes. These are denoted as <span class="math inline">\(Y_{i,0}\)</span>, …, <span class="math inline">\(Y_{i,6}\)</span>, where t = 0 represents the year of winning a lottery—recall that individuals in the control group also received a modest, one-time prize that year. We will treat the labor earnings from the three years immediately preceding the lottery win, i.e., <span class="math inline">\(Y_{i,-3}\)</span>, <span class="math inline">\(Y_{i,-2}\)</span>, <span class="math inline">\(Y_{i,-1}\)</span>, as well as their average, as placebo outcomes. The labor earnings from the three years before those, i.e., <span class="math inline">\(Y_{i,-6}\)</span>, <span class="math inline">\(Y_{i,-5}\)</span>, <span class="math inline">\(Y_{i,-4}\)</span>, will be used as covariates for adjustment, alongside a set of time-invariant pre-lottery-winning variables. These include the number of tickets purchased (tixbot), gender (male), employment status at the time of winning (workthen), age when the lottery was won (agew), total years of education (educ), and the presence of a college degree (college).</p>
<p>First, we estimate the overlap between the two treatment groups(the big winner treatment group on the left &amp; the smaller winner treatment group on the right) and the control group. The <code>assess_overlap</code> function will conveniently present the overlap between the control and the treated.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># select big winner</span></span>
<span></span>
<span><span class="va">s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">tr1</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">co</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s1</span><span class="op">$</span><span class="va">xearn.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">s1</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"xearn."</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># avg pre outcome</span></span>
<span><span class="va">s1</span><span class="op">$</span><span class="va">yearn.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">s1</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"yearn."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># avg pst outcome</span></span>
<span></span>
<span><span class="co"># assess overlap</span></span>
<span><span class="va">treat</span> <span class="op">&lt;-</span> <span class="st">"tr"</span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tixbot"</span>, <span class="st">"male"</span>, <span class="st">"workthen"</span>, <span class="st">"agew"</span>, <span class="st">"educ"</span>, <span class="st">"college"</span>,</span>
<span>           <span class="st">"xearn.1"</span>, <span class="st">"xearn.2"</span>, <span class="st">"xearn.3"</span>, <span class="st">"yearw"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s1_ps</span> <span class="op">&lt;-</span> <span class="fu">assess_overlap</span><span class="op">(</span>data <span class="op">=</span> <span class="va">s1</span>, treat <span class="op">=</span> <span class="va">treat</span>, cov <span class="op">=</span> <span class="va">covar</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5.5</span>, <span class="fl">1</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.4</span>, <span class="fl">0.4</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select small winner</span></span>
<span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">tr2</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">co</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s2</span><span class="op">$</span><span class="va">xearn.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">s2</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"xearn."</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># avg pre outcome</span></span>
<span><span class="va">s2</span><span class="op">$</span><span class="va">yearn.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">s2</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"yearn."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># avg pst outcome</span></span>
<span></span>
<span><span class="co"># assess overlap</span></span>
<span></span>
<span><span class="va">treat</span> <span class="op">&lt;-</span> <span class="st">"tr"</span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tixbot"</span>, <span class="st">"male"</span>, <span class="st">"workthen"</span>, <span class="st">"agew"</span>, <span class="st">"educ"</span>, <span class="st">"college"</span>,</span>
<span>           <span class="st">"xearn.1"</span>, <span class="st">"xearn.2"</span>, <span class="st">"xearn.3"</span>, <span class="st">"yearw"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s2_ps</span> <span class="op">&lt;-</span> <span class="fu">assess_overlap</span><span class="op">(</span>data <span class="op">=</span> <span class="va">s2</span>, treat <span class="op">=</span> <span class="va">treat</span>, cov <span class="op">=</span> <span class="va">covar</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-50"></span>
<img src="tutorial0601_files/figure-html/unnamed-chunk-50-1.png" alt="FIGURE 7. SubfigureA:Big Winners vs Non-Winners. SubfigureB:Small Winners vs Non-Winners." width="100%"><p class="caption">
Figure 4.1: FIGURE 7. SubfigureA:Big Winners vs Non-Winners. SubfigureB:Small Winners vs Non-Winners.
</p>
</div>
<p>The figures indicate that while the propensity score distributions of individuals in the treatment groups differ from that of the control group, the propensity scores of the treatment groups still fall within the support of the control group.</p>
</div>
<div id="trimming-to-improve-overlap-2" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Trimming to Improve Overlap<a class="anchor" aria-label="anchor" href="#trimming-to-improve-overlap-2"><i class="fas fa-link"></i></a>
</h2>
<p>To improve overlap, we further trim the control group for each of the two treatment groups by implementing 1:1 matching based on propensity scores. Then, we reassess the overlap for the two trimmed datasets.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># matching</span></span>
<span>  <span class="co">## In the matching procedure, we don't need Y actually, so just pick one Y to satisfy function's requirement</span></span>
<span></span>
<span><span class="va">s1_ps_match</span> <span class="op">&lt;-</span> <span class="fu">psmatch</span><span class="op">(</span>data <span class="op">=</span> <span class="va">s1_ps</span>, Y <span class="op">=</span> <span class="st">"yearn.2"</span>, treat <span class="op">=</span> <span class="va">treat</span>, cov <span class="op">=</span> <span class="va">covar</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># assess overlap again</span></span>
<span></span>
<span><span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu">assess_overlap</span><span class="op">(</span>data <span class="op">=</span> <span class="va">s1_ps_match</span>, treat <span class="op">=</span> <span class="va">treat</span>, cov <span class="op">=</span> <span class="va">covar</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># matching</span></span>
<span>  <span class="co">## In the matching procedure, we don't need Y actually, so just pick one Y to satisfy function's requirement</span></span>
<span></span>
<span><span class="va">s2_ps_match</span> <span class="op">&lt;-</span> <span class="fu">psmatch</span><span class="op">(</span>data <span class="op">=</span> <span class="va">s2_ps</span>, Y <span class="op">=</span> <span class="st">"yearn.2"</span>, treat <span class="op">=</span> <span class="va">treat</span>, cov <span class="op">=</span> <span class="va">covar</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># assess overlap again</span></span>
<span></span>
<span><span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu">assess_overlap</span><span class="op">(</span>data <span class="op">=</span> <span class="va">s2_ps_match</span>, treat <span class="op">=</span> <span class="va">treat</span>, cov <span class="op">=</span> <span class="va">covar</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-51"></span>
<img src="tutorial0601_files/figure-html/unnamed-chunk-51-1.png" alt="FIGURE A9. SubfigureA:Big Winners vs Control. SubfigureB:Small Winners vs Control." width="100%"><p class="caption">
Figure 4.2: FIGURE A9. SubfigureA:Big Winners vs Control. SubfigureB:Small Winners vs Control.
</p>
</div>
<p>From the histograms, trimming improved the overlap for the big winner treatment group but not for the small winner one. Here are a few points to consider.</p>
<p>First, if the treatment and control groups have very different covariate distributions, it is difficult to achieve good overlap even after trimming. As the plots suggest, the big winner group likely had more control units that were similar to the treated units, making it easier to find matches.</p>
<p>Second, the small winner group’s log odds have a wide range before trimming and remain wide after trimming. This suggests that the small winner group might have more extreme values or outliers that are not present in the control group.</p>
</div>
<div id="att-and-placebo-estimates" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> ATT and Placebo Estimates<a class="anchor" aria-label="anchor" href="#att-and-placebo-estimates"><i class="fas fa-link"></i></a>
</h2>
<p>Since trimming does not significantly improve the overlap between the treated and the control, we will proceed with the original dataset.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># prepare data again</span></span>
<span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">tr</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">winner</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">tr1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">bigwinner</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># big winner</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">tr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">bigwinner</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">d</span><span class="op">$</span><span class="va">winner</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># small winner</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">co</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">winner</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># control</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">college</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">educ</span> <span class="op">&gt;=</span> <span class="fl">16</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">[</span><span class="fl">9</span><span class="op">:</span><span class="fl">14</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">[</span><span class="fl">15</span><span class="op">:</span><span class="fl">21</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">earnings_1yr_before</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">x6</span></span>
<span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">xearn.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># avg pre outcome</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">yearn.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># avg pst outcome</span></span>
<span></span>
<span><span class="va">s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">tr1</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">co</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># big winner</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">tr2</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">co</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># small winner</span></span>
<span></span>
<span><span class="co"># estimate and placebo analyses</span></span>
<span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tixbot"</span>, <span class="st">"male"</span>, <span class="st">"workthen"</span>, <span class="st">"agew"</span>, <span class="st">"educ"</span>, <span class="st">"college"</span>,</span>
<span>           <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>, <span class="st">"yearw"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># big winners</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">out1</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s1</span>, <span class="st">"yearn.avg"</span>, <span class="st">"tr"</span>, <span class="va">covar</span><span class="op">)</span></span>
<span><span class="co">#out1</span></span>
<span><span class="va">out2</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s1</span>, <span class="st">"xearn.avg"</span>, <span class="st">"tr"</span>, <span class="va">covar</span><span class="op">)</span></span>
<span><span class="co">#out2</span></span>
<span><span class="co"># small winners</span></span>
<span><span class="va">out3</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s2</span>, <span class="st">"yearn.avg"</span>, <span class="st">"tr"</span>, <span class="va">covar</span><span class="op">)</span></span>
<span><span class="co">#out3</span></span>
<span><span class="va">out4</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s2</span>, <span class="st">"xearn.avg"</span>, <span class="st">"tr"</span>, <span class="va">covar</span><span class="op">)</span></span>
<span><span class="co">#out4</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_coef</span><span class="op">(</span><span class="va">out1</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, main <span class="op">=</span> <span class="st">"Big Winner vs. Non-Winner"</span>, main.pos <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_coef</span><span class="op">(</span><span class="va">out2</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, main <span class="op">=</span> <span class="st">"Big Winner vs. Non-Winner: Placebo Test"</span>, main.pos <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_coef</span><span class="op">(</span><span class="va">out3</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, main <span class="op">=</span> <span class="st">"Small Winner vs. Non-Winner"</span>, main.pos <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_coef</span><span class="op">(</span><span class="va">out4</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, main <span class="op">=</span> <span class="st">"Small Winner vs. Non-Winner: Placebo Test"</span>, main.pos <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-53"></span>
<img src="tutorial0601_files/figure-html/unnamed-chunk-53-1.png" alt="FIGURE 8. ATT and Placebo Estimates: IRSData" width="100%"><p class="caption">
Figure 4.3: FIGURE 8. ATT and Placebo Estimates: IRSData
</p>
</div>
<p>The ATT results are presented in the table below:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print the result</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">out1</span>, <span class="va">out2</span>, <span class="va">out3</span>, <span class="va">out4</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">out1</span><span class="op">)</span></span>
<span><span class="va">sav</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="st">""</span>, <span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">*</span><span class="fl">3</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">sav</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">*</span><span class="fl">3</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.2f"</span>, <span class="va">out</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">sav</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">*</span><span class="fl">3</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.2f"</span>, <span class="va">out</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">sav</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Big Prize: Post-Winning Average Earning"</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">"Big Prize: Pre-Winning Average Earning"</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">"Small Prize: Post-Winning Average Earning"</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">"Small Prize: Pre-Winning Average Earning"</span>, <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">sav</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Difference-in-Means"</span>, <span class="st">"Regression"</span>, <span class="st">" Oaxaca Blinder"</span>, <span class="st">"GRF"</span>, <span class="st">"NN Matching"</span>, <span class="st">"PS Matching"</span>, <span class="st">"IPW"</span>, <span class="st">"CBPS"</span>, <span class="st">"Entropy Balancing"</span>, <span class="st">"DML-ElasticNet"</span>, <span class="st">"AIPW-GRF"</span><span class="op">)</span></span>
<span><span class="va">sav</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>booktabs<span class="op">=</span><span class="cn">TRUE</span>, caption <span class="op">=</span> <span class="st">" Table A5 in the Supplementary Materials (SM), ATT and Placebo Estimates: IRSData"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:unnamed-chunk-54">Table 4.1: </span> Table A5 in the Supplementary Materials (SM), ATT and Placebo Estimates: IRSData</caption>
<colgroup>
<col width="9%">
<col width="18%">
<col width="3%">
<col width="1%">
<col width="17%">
<col width="3%">
<col width="1%">
<col width="19%">
<col width="3%">
<col width="1%">
<col width="18%">
<col width="3%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Big Prize: Post-Winning Average Earning</th>
<th align="left"></th>
<th align="left"></th>
<th align="left">Big Prize: Pre-Winning Average Earning</th>
<th align="left"></th>
<th align="left"></th>
<th align="left">Small Prize: Post-Winning Average Earning</th>
<th align="left"></th>
<th align="left"></th>
<th align="left">Small Prize: Pre-Winning Average Earning</th>
<th align="left"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Difference-in-Means</td>
<td align="left">-8.33</td>
<td align="left">(2.13)</td>
<td align="left"></td>
<td align="left">-0.33</td>
<td align="left">(2.39)</td>
<td align="left"></td>
<td align="left">-5.41</td>
<td align="left">(1.37)</td>
<td align="left"></td>
<td align="left">-4.58</td>
<td align="left">(1.35)</td>
</tr>
<tr class="even">
<td align="left">Regression</td>
<td align="left">-9.17</td>
<td align="left">(2.32)</td>
<td align="left"></td>
<td align="left">-0.87</td>
<td align="left">(1.36)</td>
<td align="left"></td>
<td align="left">-4.09</td>
<td align="left">(1.15)</td>
<td align="left"></td>
<td align="left">-0.46</td>
<td align="left">(0.59)</td>
</tr>
<tr class="odd">
<td align="left">Oaxaca Blinder</td>
<td align="left">-9.49</td>
<td align="left">(2.66)</td>
<td align="left"></td>
<td align="left">-0.52</td>
<td align="left">(3.03)</td>
<td align="left"></td>
<td align="left">-3.20</td>
<td align="left">(1.15)</td>
<td align="left"></td>
<td align="left">0.30</td>
<td align="left">(1.20)</td>
</tr>
<tr class="even">
<td align="left">GRF</td>
<td align="left">-8.17</td>
<td align="left">(2.62)</td>
<td align="left"></td>
<td align="left">-0.26</td>
<td align="left">(3.01)</td>
<td align="left"></td>
<td align="left">-2.41</td>
<td align="left">(1.13)</td>
<td align="left"></td>
<td align="left">-0.17</td>
<td align="left">(1.19)</td>
</tr>
<tr class="odd">
<td align="left">NN Matching</td>
<td align="left">-9.62</td>
<td align="left">(2.17)</td>
<td align="left"></td>
<td align="left">-0.53</td>
<td align="left">(1.32)</td>
<td align="left"></td>
<td align="left">-3.02</td>
<td align="left">(0.95)</td>
<td align="left"></td>
<td align="left">0.36</td>
<td align="left">(0.60)</td>
</tr>
<tr class="even">
<td align="left">PS Matching</td>
<td align="left">-5.69</td>
<td align="left">(3.13)</td>
<td align="left"></td>
<td align="left">2.69</td>
<td align="left">(3.57)</td>
<td align="left"></td>
<td align="left">-3.32</td>
<td align="left">(1.49)</td>
<td align="left"></td>
<td align="left">-2.97</td>
<td align="left">(1.44)</td>
</tr>
<tr class="odd">
<td align="left">IPW</td>
<td align="left">-8.40</td>
<td align="left">(2.64)</td>
<td align="left"></td>
<td align="left">-0.79</td>
<td align="left">(2.85)</td>
<td align="left"></td>
<td align="left">-3.73</td>
<td align="left">(1.72)</td>
<td align="left"></td>
<td align="left">-2.23</td>
<td align="left">(1.73)</td>
</tr>
<tr class="even">
<td align="left">CBPS</td>
<td align="left">-9.91</td>
<td align="left">(3.69)</td>
<td align="left"></td>
<td align="left">-0.55</td>
<td align="left">(3.53)</td>
<td align="left"></td>
<td align="left">-3.74</td>
<td align="left">(2.76)</td>
<td align="left"></td>
<td align="left">-1.23</td>
<td align="left">(2.49)</td>
</tr>
<tr class="odd">
<td align="left">Entropy Balancing</td>
<td align="left">-10.27</td>
<td align="left">(4.02)</td>
<td align="left"></td>
<td align="left">-0.64</td>
<td align="left">(3.80)</td>
<td align="left"></td>
<td align="left">-2.64</td>
<td align="left">(3.20)</td>
<td align="left"></td>
<td align="left">0.20</td>
<td align="left">(2.88)</td>
</tr>
<tr class="even">
<td align="left">DML-ElasticNet</td>
<td align="left">-8.10</td>
<td align="left">(2.17)</td>
<td align="left"></td>
<td align="left">-0.81</td>
<td align="left">(1.28)</td>
<td align="left"></td>
<td align="left">-4.22</td>
<td align="left">(1.13)</td>
<td align="left"></td>
<td align="left">-0.49</td>
<td align="left">(0.57)</td>
</tr>
<tr class="odd">
<td align="left">AIPW-GRF</td>
<td align="left">-8.25</td>
<td align="left">(1.85)</td>
<td align="left"></td>
<td align="left">0.04</td>
<td align="left">(1.17)</td>
<td align="left"></td>
<td align="left">-2.42</td>
<td align="left">(0.95)</td>
<td align="left"></td>
<td align="left">0.18</td>
<td align="left">(0.53)</td>
</tr>
</tbody>
</table></div>
<p>Using the original data, the above table presents both the ATT estimates and results from a placebo test using various estimators. Columns 1 and 2 compare “big winners” with the controls, while columns 3 and 4 compare “small winners” with the control. Columns 1 and 3 display the ATT estimates, with the outcome being the average annual labor earnings from Year 0 to Year 6. The results of the placebo test are reported in columns 2 and 4, where the placebo outcome is the average annual labor earnings from Year 3 to Year 1. The results indicate that various methods produce consistent results, which align with the findings reported in the original paper: winning a large prize leads to a significant decrease in labor income in the following years, averaging as much as $8,000 annually. In contrast, winning a smaller prize results in a more modest decline, averaging approximately $3,000 per year. Notably, when applying doubly robust estimators like AIPW-GRF, the placebo test estimates hover near zero, reinforcing the credibility of the unconfoundedness assumption.</p>
</div>
<div id="att-visualization" class="section level2" number="4.5">
<h2>
<span class="header-section-number">4.5</span> ATT Visualization<a class="anchor" aria-label="anchor" href="#att-visualization"><i class="fas fa-link"></i></a>
</h2>
<p>While tables can enumerate the standard errors for each estimate, graphical visualization offer a more intuitive presentation of our findings. To facilitate a clearer understanding, we calculate and compare the ATT estimates derived from both the original and the matched dataset. The following code computes the difference-in-means alongside the AIPW-GRF estimates.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># big winners</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s1_ps</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="va">s1_ps_match</span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tixbot"</span>, <span class="st">"male"</span>, <span class="st">"workthen"</span>, <span class="st">"agew"</span>, <span class="st">"educ"</span>, <span class="st">"college"</span>, </span>
<span>    <span class="st">"xearn.1"</span>, <span class="st">"xearn.2"</span>, <span class="st">"xearn.3"</span>, <span class="st">"yearw"</span><span class="op">)</span></span>
<span><span class="va">treat</span> <span class="op">&lt;-</span> <span class="st">"tr"</span></span>
<span><span class="co"># full dataset</span></span>
<span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"xearn."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"yearn."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">outcomes</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s</span>, <span class="va">outcomes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"tr"</span>, <span class="va">covar</span>,</span>
<span>    methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diff"</span>, <span class="st">"aipw_grf"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co">#cat(i, "\n")</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># matched dataset</span></span>
<span><span class="va">est2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">est2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">outcomes</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">est2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s2</span>, <span class="va">outcomes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"tr"</span>, <span class="va">covar</span>,</span>
<span>    methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diff"</span>, <span class="st">"aipw_grf"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co">#cat(i, "\n")</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Small winners</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s2_ps</span></span>
<span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="va">s2_ps_match</span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tixbot"</span>, <span class="st">"male"</span>, <span class="st">"workthen"</span>, <span class="st">"agew"</span>, <span class="st">"educ"</span>, <span class="st">"college"</span>, </span>
<span>    <span class="st">"xearn.1"</span>, <span class="st">"xearn.2"</span>, <span class="st">"xearn.3"</span>, <span class="st">"yearw"</span><span class="op">)</span></span>
<span><span class="va">treat</span> <span class="op">&lt;-</span> <span class="st">"tr"</span></span>
<span><span class="co"># full dataset</span></span>
<span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"xearn."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"yearn."</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">est3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">est3</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">outcomes</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">est3</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s</span>, <span class="va">outcomes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"tr"</span>, <span class="va">covar</span>,</span>
<span>    methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diff"</span>, <span class="st">"aipw_grf"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co">#cat(i, "\n")</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># matched dataset</span></span>
<span><span class="va">est4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">est4</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">outcomes</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">est4</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">estimate_all</span><span class="op">(</span><span class="va">s2</span>, <span class="va">outcomes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"tr"</span>, <span class="va">covar</span>,</span>
<span>    methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diff"</span>, <span class="st">"aipw_grf"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co">#cat(i, "\n")</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>ATT Results Visualization:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.7</span>, <span class="fl">13.3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"n"</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    ylab <span class="op">=</span> <span class="st">"Effects on Earnings (thousand USD)"</span>, xlab <span class="op">=</span> <span class="st">"Year Relative to Winning"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span><span class="op">(</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">13</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, v<span class="op">=</span> <span class="fl">6.5</span>, col <span class="op">=</span> <span class="st">"gray60"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">4</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># full dataset with DIM</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">0.15</span>, <span class="va">i</span><span class="op">-</span><span class="fl">0.15</span><span class="op">)</span>, <span class="va">est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey60"</span><span class="op">)</span> <span class="co"># CI</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">0.15</span>, <span class="va">est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">18</span>, col <span class="op">=</span> <span class="st">"grey60"</span>, cex <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>  <span class="co"># Coef </span></span>
<span>    <span class="co"># full dataset</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">i</span><span class="op">)</span>, <span class="va">est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># CI</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>  <span class="co"># Coef </span></span>
<span>    <span class="co"># matched dataset</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">0.15</span>, <span class="va">i</span><span class="op">+</span><span class="fl">0.15</span><span class="op">)</span>, <span class="va">est2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"maroon"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="co"># CI</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">0.15</span>, <span class="va">est2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"maroon"</span>, pch <span class="op">=</span> <span class="fl">17</span><span class="op">)</span>  <span class="co"># Coef  </span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DIM,  Full (43: 259)"</span>, <span class="st">"AIPW, Full (43: 259)"</span>, </span>
<span>    <span class="st">"AIPW, PS Matched (43: 43)"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">16</span>, <span class="fl">17</span><span class="op">)</span>, </span>
<span>    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey50"</span>, <span class="st">"black"</span>, <span class="st">"maroon"</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.7</span>, <span class="fl">13.3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"n"</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    ylab <span class="op">=</span> <span class="st">"Effects on Earnings (thousand USD)"</span>, xlab <span class="op">=</span> <span class="st">"Year Relative to Winning"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span><span class="op">(</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">13</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, v<span class="op">=</span> <span class="fl">6.5</span>, col <span class="op">=</span> <span class="st">"gray60"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">4</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># full dataset with DIM</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">0.15</span>, <span class="va">i</span><span class="op">-</span><span class="fl">0.15</span><span class="op">)</span>, <span class="va">est3</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey60"</span><span class="op">)</span> <span class="co"># CI</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">0.15</span>, <span class="va">est3</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">18</span>, col <span class="op">=</span> <span class="st">"grey60"</span>, cex <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>  <span class="co"># Coef </span></span>
<span>    <span class="co"># full dataset</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">i</span><span class="op">)</span>, <span class="va">est3</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># CI</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">est3</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>  <span class="co"># Coef </span></span>
<span>    <span class="co"># matched dataset</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">0.15</span>, <span class="va">i</span><span class="op">+</span><span class="fl">0.15</span><span class="op">)</span>, <span class="va">est4</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"maroon"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="co"># CI</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">0.15</span>, <span class="va">est4</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"maroon"</span>, pch <span class="op">=</span> <span class="fl">17</span><span class="op">)</span>  <span class="co"># Coef  </span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DIM,  Full (194: 259)"</span>, <span class="st">"AIPW, Full (194: 259)"</span>, </span>
<span>    <span class="st">"AIPW, PS Matched (194: 194)"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">16</span>, <span class="fl">17</span><span class="op">)</span>, </span>
<span>    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey50"</span>, <span class="st">"black"</span>, <span class="st">"maroon"</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-56"></span>
<img src="tutorial0601_files/figure-html/unnamed-chunk-56-1.png" alt="9(A) and (B). ATT Estimates: IRS Data" width="100%"><p class="caption">
Figure 4.4: 9(A) and (B). ATT Estimates: IRS Data
</p>
</div>
<p>The above figures show that in the comparison of “big winners” and “non-winners,” AIPW using the original or trimmed data produces estimates very similar to a simple difference-in-means estimator, suggesting minimal selection bias between the two groups. On the other hand, when comparing “small winners” with “non-winners,” the estimates from AIPW and difference-in-means diverge. However, findings from the former are much more credible than those from the latter because difference-in-means does not fare well in the placebo tests, whereas the former yields placebo estimates that are nearly 0.</p>
</div>
<div id="catt-estimates-and-visualization" class="section level2" number="4.6">
<h2>
<span class="header-section-number">4.6</span> CATT Estimates and Visualization<a class="anchor" aria-label="anchor" href="#catt-estimates-and-visualization"><i class="fas fa-link"></i></a>
</h2>
<p>To assess the effects of the treatment, we proceed to evaluate the CATT, determined at the covariate values of the treated units. This assessment is conducted using the AIPW-GRF method for each of the ten outcomes within both the original big winners and the original small winners samples.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">s1_ps</span></span>
<span><span class="va">treat</span> <span class="op">&lt;-</span> <span class="st">"tr"</span></span>
<span><span class="va">ntr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">ntr</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">att</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">ntr</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">outcomes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">catt.out</span> <span class="op">&lt;-</span> <span class="fu">catt</span><span class="op">(</span><span class="va">data</span>, <span class="va">Y</span>, <span class="va">treat</span>, <span class="va">covar</span><span class="op">)</span></span>
<span>    <span class="va">tau</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">catt.out</span><span class="op">$</span><span class="va">catt</span></span>
<span>    <span class="va">att</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">catt.out</span><span class="op">$</span><span class="va">att</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>     </span>
<span>    <span class="co">#cat(i, "\n")</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">s2_ps</span></span>
<span><span class="va">treat</span> <span class="op">&lt;-</span> <span class="st">"tr"</span></span>
<span><span class="va">ntr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">tau2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">ntr</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">att2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">ntr</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">outcomes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">catt.out</span> <span class="op">&lt;-</span> <span class="fu">catt</span><span class="op">(</span><span class="va">data</span>, <span class="va">Y</span>, <span class="va">treat</span>, <span class="va">covar</span><span class="op">)</span></span>
<span>    <span class="va">tau2</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">catt.out</span><span class="op">$</span><span class="va">catt</span></span>
<span>    <span class="va">att2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">catt.out</span><span class="op">$</span><span class="va">att</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>     </span>
<span>    <span class="co">#cat(i, "\n")</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In both plots, the years before winning (Years -3, -2, and -1) serve as the placebo test period. In the years leading up to the win, the CATT estimates are expected to be around 0, which would suggest that the treatment (winning the lottery) has no effect in these years. The width of the violins indicates the density of the effect estimates — wider sections of the violin plot suggest that more data points are present at that effect size.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.7</span>, <span class="fl">13.3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"n"</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    ylab <span class="op">=</span> <span class="st">"Effects on Earnings (thousand USD)"</span>, xlab <span class="op">=</span> <span class="st">"Year Relative to Winning"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span><span class="op">(</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">13</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, v<span class="op">=</span> <span class="fl">6.5</span>, col <span class="op">=</span> <span class="st">"gray60"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">4</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">tau</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, bw <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html">polygon</a></span><span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="va">dens</span><span class="op">$</span><span class="va">y</span>, <span class="va">dens</span><span class="op">$</span><span class="va">x</span>, col <span class="op">=</span> <span class="st">"#AAAAAA50"</span>, border <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="va">dens</span><span class="op">$</span><span class="va">y</span>, <span class="va">dens</span><span class="op">$</span><span class="va">x</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">0.01</span>,  <span class="va">att</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>  <span class="co"># Coef</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.7</span>, <span class="fl">13.3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"n"</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    ylab <span class="op">=</span> <span class="st">"Effects on Earnings (thousand USD)"</span>, xlab <span class="op">=</span> <span class="st">"Year Relative to Winning"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html">box</a></span><span class="op">(</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">13</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, v<span class="op">=</span> <span class="fl">6.5</span>, col <span class="op">=</span> <span class="st">"gray60"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">4</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">outcomes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">tau2</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, bw <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html">polygon</a></span><span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="va">dens</span><span class="op">$</span><span class="va">y</span>, <span class="va">dens</span><span class="op">$</span><span class="va">x</span>, col <span class="op">=</span> <span class="st">"#AAAAAA50"</span>, border <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="va">dens</span><span class="op">$</span><span class="va">y</span>, <span class="va">dens</span><span class="op">$</span><span class="va">x</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">0.01</span>,  <span class="va">att2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>  <span class="co"># Coef</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-58"></span>
<img src="tutorial0601_files/figure-html/unnamed-chunk-58-1.png" alt="9(C) and (D). CATT Estimates: IRS Data" width="100%"><p class="caption">
Figure 4.5: 9(C) and (D). CATT Estimates: IRS Data
</p>
</div>
<p>Beyond providing corroborative evidence for the placebo tests (i.e., CATT estimates align closely with 0 in the years leading up to the win as expected), the figures also reveal substantial treatment effect heterogeneity among lottery winners. In Post-Winning Years (Years 1 to 6), the effect of winning on earnings changes over time.</p>
<p>Notably, the distributions of the CATT for many post-winning years appear bimodal. We observe two peaks in the distribution of the effects, which could suggest there are two different common outcomes or reactions to winning among the two treated groups.</p>
</div>
<div id="summary-1" class="section level2" number="4.7">
<h2>
<span class="header-section-number">4.7</span> Summary<a class="anchor" aria-label="anchor" href="#summary-1"><i class="fas fa-link"></i></a>
</h2>
<p>Overall, we find that in the lottery study, the unconfoundedness assumption can be empirically validated through placebo tests, bolstering the credibility of the causal estimates. Importantly, the unconfoundedness assumption is much more believable in this study than in the LaLonde case because the inherent randomization of lotteries played a key role in treatment assignment, while supplementary covariates help account for discrepancies between treatment and control groups stemming from challenges like differential responses to the survey. The inclusion of six preceding outcomes also proves invaluable, as they likely explain both the selection mechanism and are highly correlated with the outcome variables; moreover, they also serve as good candidates for placebo outcomes, given their comparability to these outcomes.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="original-lalonde-data-male-sample.html"><span class="header-section-number">3</span> Original LaLonde Data (Male Sample)</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-lottery-data"><span class="header-section-number">4</span> The Lottery Data</a></li>
<li><a class="nav-link" href="#the-imbens-rubin-and-sacerdote-irs-lottery-data"><span class="header-section-number">4.1</span> The Imbens, Rubin, and Sacerdote (IRS) Lottery Data</a></li>
<li><a class="nav-link" href="#assessing-overlap-2"><span class="header-section-number">4.2</span> Assessing Overlap</a></li>
<li><a class="nav-link" href="#trimming-to-improve-overlap-2"><span class="header-section-number">4.3</span> Trimming to Improve Overlap</a></li>
<li><a class="nav-link" href="#att-and-placebo-estimates"><span class="header-section-number">4.4</span> ATT and Placebo Estimates</a></li>
<li><a class="nav-link" href="#att-visualization"><span class="header-section-number">4.5</span> ATT Visualization</a></li>
<li><a class="nav-link" href="#catt-estimates-and-visualization"><span class="header-section-number">4.6</span> CATT Estimates and Visualization</a></li>
<li><a class="nav-link" href="#summary-1"><span class="header-section-number">4.7</span> Summary</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/xuyiqing/lalonde/blob/main/tutorial/04-IRS.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/xuyiqing/lalonde/edit/main/tutorial/04-IRS.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tutorial and Code for ‘LaLonde (1986) after Nearly Four Decades: Lessons Learned’</strong>" was written by Guido Imbens, Yiqing Xu. It was last built on 2024-06-02.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
